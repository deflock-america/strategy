name: FOIA Tracker Dashboard

on:
  # Trigger on new FOIA issues, PRs, or schedule
  issues:
    types: [opened, edited, closed, reopened]
  pull_request:
    types: [opened, closed, synchronize]
  schedule:
    # Daily update at 6AM EST
    - cron: '0 6 * * *'
  workflow_dispatch: # Manual trigger

jobs:
  track-foia:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyGithub pandas jinja2 requests beautifulsoup4

      - name: Generate FOIA Dashboard
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python .github/scripts/generate-dashboard.py

      - name: Update FOIA Status Table
        run: |
          python .github/scripts/update-status-table.py

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public

      - name: Update Issue Statuses
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const statusData = JSON.parse(fs.readFileSync('foia-status.json', 'utf8'));
            
            for (const city of Object.keys(statusData)) {
              console.log(`ðŸ“Š ${city}: ${statusData[city].status}`);
            }

  notify-slack:
    needs: track-foia
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: failure
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
